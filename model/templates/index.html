<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Drowsiness Detection</title>
    <style>
        body {
            margin: 0;
            background: #111;
            color: #fff;
            font-family: sans-serif;
            text-align: center;
        }

        h2 {
            margin-top: 20px;
            font-size: 28px;
        }

        #snapshot {
            margin-top: 20px;
            border: 4px solid #444;
            border-radius: 8px;
            max-width: 90%;
            height: auto;
        }

        .alert-banner {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: red;
            color: #fff;
            padding: 12px 24px;
            font-size: 24px;
            border-radius: 8px;
            z-index: 999;
            opacity: 0;
            animation: fade 3s forwards;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        }

        @keyframes fade {
            0% {
                opacity: 0;
                transform: translateX(-50%) scale(0.9)
            }

            10% {
                opacity: 1;
                transform: translateX(-50%) scale(1)
            }

            90% {
                opacity: 1
            }

            100% {
                opacity: 0;
                transform: translateX(-50%) scale(1)
            }
        }

        #log-section {
            margin: 40px auto;
            max-width: 800px;
            text-align: left;
        }

        #log-list {
            list-style: none;
            padding: 0;
        }

        #log-list li {
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 6px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <h2>Real‚ÄëTime Drowsiness Detection</h2>
    <p style="margin-top:12px; font-size:18px;">
        Vehicle Status:
        <span id="status-text" style="color:#0af;">LOADING‚Ä¶</span><br>
        Speed:
        <span id="speed-val" style="color:#ff0;">0.00</span> m/s<br>
        <span id="demo-mode" style="color:#0f0; display:none;">[DEMO MODE]</span>
    </p>

    <img id="snapshot" src="/snapshot" width="720" alt="No image yet" loading="lazy" decoding="async" />

    <div id="alert-container"></div>

    <div id="log-section">
        <h2>Drowsy Event Logs</h2>
        <ul id="log-list"></ul>
    </div>

    <div style="margin-top:20px;">
        <label for="speed-input">Set Demo Speed (m/s):</label>
        <input id="speed-input" type="number" step="0.1" style="width:80px;padding:4px" />
        <button onclick="setSpeed()" style="padding:4px 10px">Set Speed</button>
    </div>

    <!-- üîä Audio Alert -->
    <audio id="drowsy-alert" src="/static/sounds/alert.mp3" preload="auto" loop></audio>

    <script>
        const INTERVAL_MS = {{ INTERVAL_MS | default (3000) }};

        let isPlaying = false;

        // Audio activation on first tap (required for mobile)
        document.addEventListener('click', () => {
            const audio = document.getElementById("drowsy-alert");
            audio.play().then(() => {
                audio.pause();  // Just to activate it
                console.log("üîä Audio system armed");
            }).catch(e => console.log("üîá Autoplay blocked:", e));
        }, { once: true });

        // Snapshot refresh
        setInterval(() => {
            const img = document.getElementById("snapshot");
            img.src = `/snapshot?ts=${Date.now()}`;
        }, INTERVAL_MS);

        // Server-Sent Events
        const evtSrc = new EventSource("/events");
        evtSrc.onmessage = e => {
            const data = JSON.parse(e.data);
            const alertAudio = document.getElementById("drowsy-alert");

            if (data.drowsy) {
                const b = document.createElement("div");
                b.className = "alert-banner";
                b.textContent = "üö® DROWSY ALERT!";
                document.getElementById("alert-container").appendChild(b);
                setTimeout(() => b.remove(), 3000);

                if (!isPlaying) {
                    alertAudio.play().catch(err => console.warn("Audio play error:", err));
                    isPlaying = true;
                }
            } else {
                if (isPlaying) {
                    alertAudio.pause();
                    alertAudio.currentTime = 0;
                    isPlaying = false;
                }
            }
        };

        // Fetch status
        async function fetchStatus() {
            const r = await fetch("/status");
            const js = await r.json();
            document.getElementById("status-text").textContent = js.status;
            document.getElementById("speed-val").textContent = js.speed.toFixed(2);
            const demoTag = document.getElementById("demo-mode");
            demoTag.style.display = js.override ? "inline" : "none";
        }

        // Fetch logs
        async function fetchLogs() {
            try {
                const r = await fetch("/logs");
                const js = await r.json();
                const ul = document.getElementById("log-list");
                ul.innerHTML = "";
                js.logs.forEach(log => {
                    const li = document.createElement("li");
                    li.textContent =
                        `[${log.timestamp}] ${log.event_type.toUpperCase()} at ` +
                        `(${(log.lat ?? 0).toFixed(5)}, ${(log.lon ?? 0).toFixed(5)}) ‚Äì ` +
                        `Speed: ${(log.speed ?? 0).toFixed(2)} m/s`;
                    ul.appendChild(li);
                });
            } catch (e) {
                console.error("‚ùå Log fetch error:", e);
            }
        }

        // Manual speed input
        async function setSpeed() {
            const v = parseFloat(document.getElementById("speed-input").value);
            if (isNaN(v)) return alert("Enter valid speed");
            await fetch("/speed", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ speed: v })
            });
        }

        // Start
        fetchStatus();
        fetchLogs();
        setInterval(fetchStatus, 2000);
        setInterval(fetchLogs, 2000);
    </script>
</body>

</html>